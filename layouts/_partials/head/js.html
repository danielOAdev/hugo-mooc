{{- with resources.Get "js/init.js" -}}
<script src="{{ .RelPermalink }}"></script>
{{- end -}}

{{/* Google Analytics */}}
{{ if not site.Config.Privacy.GoogleAnalytics.Disable }}
  {{- with site.Config.Services.GoogleAnalytics.ID }}
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('consent', 'default', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': JSON.parse(localStorage.getItem('cookie-GA')) ? 'granted' : 'denied'
      });
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
    <script>
      gtag('js', new Date());
      gtag('config', '{{ . }}', {
        'VigiConfigTema': Vigi.getNomeDoTemaEmPreferencia(),
        'VigiConfigTamanhoDoTexto': Vigi.getPreferencia('tamanhoDoTexto')
      });
    </script>
  {{- end }}
{{- end -}}

{{/* Import map */}}
<script type="importmap">
  {
    "imports": {
    {{ with resources.Get "js/popperjs/core/dist/esm/popper.js" }}
      "@popperjs/core":"{{ partial "RelURLToCurPage.html" (dict "Page" $ "url" .RelPermalink) }}"
    {{ end }}
    }
  }
</script>

{{/*
Como não estamos usando "js.Build", temos que publicar manualmente módulos importados.
*/}}
{{- range resources.Match "js/**" -}}
  {{- .Publish -}}
{{- end -}}

{{/*
Vigi Barrel module
*/}}
{{- with resources.Get "js/index.mjs" -}}
  <script type="module" src="{{ .RelPermalink }}"></script>
  {{- if eq hugo.Environment "development" -}}
    {{/* Adiciona exportações ao escopo global */}}
    {{ $link := partial "RelURLToCurPage.html" (dict "Page" $ "url" .RelPermalink) }}
    <script async>import('{{ $link }}').then(modulos => { Object.assign(globalThis, modulos) });</script>
  {{- end -}}
{{- end -}}

{{- define "_partials/RelURLToCurPage.html" -}}
  {{- $url := .url -}}
  {{- $currenturl := .Page.RelPermalink -}}
  {{- $currentpath := trim (path.Dir $currenturl) "/" -}}
  {{- $segments := split $currentpath "/" -}}
  {{- $backtrack := "" -}}
  {{- $result := $url -}}

  {{- if gt (len $currentpath) 0 -}}
    {{- range $k, $v := $segments -}}
      {{- $backtrack = printf "%s%s" $backtrack "../" -}}
    {{- end -}}
    {{- $result = path.Join $backtrack $url -}}
  {{- else -}}
    {{- $backtrack = "./" -}}
    {{- $result = printf "%s%s" $backtrack (strings.TrimLeft "./" $url) -}}
  {{- end -}}
  {{- return $result -}}
{{- end -}}